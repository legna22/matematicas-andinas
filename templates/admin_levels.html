{% extends "base.html" %}

{% block title %}Editor de Niveles - Matemáticas Andinas{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/game.css') }}">
<style>
.admin-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 10px;
}

.game-tabs {
    display: flex;
    margin-bottom: 20px;
    border-bottom: 2px solid #8B4513;
}

.tab-button {
    padding: 10px 20px;
    border: none;
    background: none;
    cursor: pointer;
    font-size: 16px;
    color: #8B4513;
}

.tab-button.active {
    background: #8B4513;
    color: white;
}

.levels-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.level-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    background: white;
}

.level-input {
    width: 100%;
    padding: 8px;
    margin: 5px 0;
    border: 1px solid #ccc;
    border-radius: 4px;
}

.btn-small {
    padding: 5px 10px;
    font-size: 12px;
}
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <header class="admin-header">
        <h1>Editor de Niveles</h1>
        <p>Configura los niveles para cada juego de Matemáticas Andinas</p>
        <!-- CHANGE HERE: Añadir controles de autenticación si es necesario -->
        <div class="admin-warning">
            ⚠️ <strong>Atención:</strong> Los cambios aquí afectan a todos los usuarios
        </div>
    </header>

    <!-- Game Tabs -->
    <div class="game-tabs">
        <button class="tab-button active" data-game="khipu">Khipu</button>
        <button class="tab-button" data-game="yupana">Yupana</button>
        <button class="tab-button" data-game="chacana">Chacana</button>
    </div>

    <!-- Levels Container -->
    <div class="levels-container">
        <!-- Khipu Levels -->
        <div class="tab-content active" data-game="khipu">
            <div class="section-header">
                <h2>Niveles de Khipu</h2>
                <button class="btn btn-primary" onclick="addLevel('khipu')">Añadir Nivel</button>
            </div>
            <div class="levels-grid" id="khipu-levels">
                <!-- Los niveles se cargarán dinámicamente -->
            </div>
        </div>

        <!-- Yupana Levels -->
        <div class="tab-content" data-game="yupana" style="display: none;">
            <div class="section-header">
                <h2>Niveles de Yupana</h2>
                <button class="btn btn-primary" onclick="addLevel('yupana')">Añadir Nivel</button>
            </div>
            <div class="levels-grid" id="yupana-levels">
                <!-- Los niveles se cargarán dinámicamente -->
            </div>
        </div>

        <!-- Chacana Levels -->
        <div class="tab-content" data-game="chacana" style="display: none;">
            <div class="section-header">
                <h2>Niveles de Chacana</h2>
                <button class="btn btn-primary" onclick="addLevel('chacana')">Añadir Nivel</button>
            </div>
            <div class="levels-grid" id="chacana-levels">
                <!-- Los niveles se cargarán dinámicamente -->
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="admin-actions">
        <button class="btn btn-success" onclick="saveAllLevels()">Guardar Cambios</button>
        <button class="btn btn-secondary" onclick="loadLevels()">Recargar</button>
        <button class="btn btn-tertiary" onclick="goHome()">Volver al Inicio</button>
    </div>

    <!-- Status Messages -->
    <div class="status-messages" id="statusMessages"></div>
</div>

<script>
let currentLevels = {{ levels | tojson | safe }}
;

document.addEventListener('DOMContentLoaded', function() {
    initLevelsEditor();
    loadLevels();
    
    // CHANGE HERE: Configuración del editor de niveles
    console.log('⚙️ Levels editor initialized');
});

function initLevelsEditor() {
    // Tab switching
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const game = this.dataset.game;
            
            // Update active tab
            tabButtons.forEach(b => b.classList.remove('active'));
            tabContents.forEach(c => {
                c.classList.remove('active');
                c.style.display = 'none';
            });
            
            this.classList.add('active');
            const targetContent = document.querySelector(`[data-game="${game}"].tab-content`);
            targetContent.classList.add('active');
            targetContent.style.display = 'block';
        });
    });
}

function loadLevels() {
    for (const game in currentLevels) {
        renderLevels(game, currentLevels[game]);
    }
}

function renderLevels(game, levels) {
    const container = document.getElementById(`${game}-levels`);
    container.innerHTML = '';
    
    levels.forEach((level, index) => {
        const levelCard = createLevelCard(game, level, index);
        container.appendChild(levelCard);
    });
}

function createLevelCard(game, level, index) {
    const card = document.createElement('div');
    card.className = 'level-card';
    card.innerHTML = `
        <div class="level-header">
            <h3>Grado ${level.grade} - Nivel ${level.level}</h3>
            <button class="btn btn-small btn-danger" onclick="removeLevel('${game}', ${index})">Eliminar</button>
        </div>
        <div class="level-fields">
            <label>Grado:</label>
            <input type="number" class="level-input" value="${level.grade}" 
                   onchange="updateLevel('${game}', ${index}, 'grade', this.value)">
            
            <label>Nivel:</label>
            <input type="number" class="level-input" value="${level.level}" 
                   onchange="updateLevel('${game}', ${index}, 'level', this.value)">
            
            <label>Mínimo:</label>
            <input type="number" class="level-input" value="${level.target_min}" 
                   onchange="updateLevel('${game}', ${index}, 'target_min', this.value)">
            
            <label>Máximo:</label>
            <input type="number" class="level-input" value="${level.target_max}" 
                   onchange="updateLevel('${game}', ${index}, 'target_max', this.value)">
            
            <label>Tiempo (segundos, 0 = sin límite):</label>
            <input type="number" class="level-input" value="${level.time}" 
                   onchange="updateLevel('${game}', ${index}, 'time', this.value)">
            
            <label>Descripción:</label>
            <input type="text" class="level-input" value="${level.desc}" 
                   onchange="updateLevel('${game}', ${index}, 'desc', this.value)">
            
            <label>Dificultad:</label>
            <select class="level-input" onchange="updateLevel('${game}', ${index}, 'difficulty', this.value)">
                <option value="facil" ${level.difficulty === 'facil' ? 'selected' : ''}>Fácil</option>
                <option value="medio" ${level.difficulty === 'medio' ? 'selected' : ''}>Medio</option>
                <option value="dificil" ${level.difficulty === 'dificil' ? 'selected' : ''}>Difícil</option>
            </select>
        </div>
    `;
    return card;
}

function addLevel(game) {
    const newLevel = {
        grade: 1,
        level: currentLevels[game].length + 1,
        target_min: 1,
        target_max: 10,
        time: 0,
        desc: "Nuevo nivel",
        difficulty: "facil",
        concepts: ["nuevo concepto"]
    };
    
    currentLevels[game].push(newLevel);
    renderLevels(game, currentLevels[game]);
}

function removeLevel(game, index) {
    if (confirm('¿Estás seguro de eliminar este nivel?')) {
        currentLevels[game].splice(index, 1);
        renderLevels(game, currentLevels[game]);
    }
}

function updateLevel(game, index, field, value) {
    if (field === 'grade' || field === 'level' || field === 'target_min' || field === 'target_max' || field === 'time') {
        currentLevels[game][index][field] = parseInt(value);
    } else {
        currentLevels[game][index][field] = value;
    }
}

function saveAllLevels() {
    fetch('/api/levels', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(currentLevels)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus('Niveles guardados correctamente', 'success');
        } else {
            showStatus('Error al guardar: ' + data.message, 'error');
        }
    })
    .catch(error => {
        showStatus('Error de conexión: ' + error.message, 'error');
    });
}

function showStatus(message, type) {
    const statusDiv = document.getElementById('statusMessages');
    statusDiv.innerHTML = `<div class="status-message ${type}">${message}</div>`;
    setTimeout(() => {
        statusDiv.innerHTML = '';
    }, 5000);
}
</script>
{% endblock %}